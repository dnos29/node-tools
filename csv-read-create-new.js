const fs = require('fs')
const csv = require('csv-parser');
const {getNowObj} = require('./date-helpers');
const books = [];
const nowObj = getNowObj();
const createCsvWriter = require('csv-writer').createObjectCsvWriter;
const csvWriter = createCsvWriter({
    path: `./upload_files/${nowObj.year}${nowObj.month}-${Date.now()}.csv`,
    header: [
      { id: 'Type', title: 'Type' },
      { id: 'SKU', title: 'SKU' },
      { id: 'Name', title: 'Name' },
      { id: 'Published', title: 'Published' },
      { id: 'Isfeatured', title: 'Is featured?' },
      { id: 'Visibilityincatalog', title: 'Visibility in catalog' },
      { id: 'Shortdescription', title: 'Short description' },
      { id: 'Description', title: 'Description' },
      { id: 'Datesalepricestarts', title: 'Date sale price starts' },
      { id: 'Datesalepriceends', title: 'Date sale price ends' },
      { id: 'Taxstatus', title: 'Tax status' },
      { id: 'Taxclass', title: 'Tax class' },
      { id: 'Instock', title: 'In stock?' },
      { id: 'Stock', title: 'Stock' },
      { id: 'Lowstockamount', title: 'Low stock amount' },
      { id: 'Backordersallowed', title: 'Backorders allowed?' },
      { id: 'Soldindividually', title: 'Sold individually?' },
      { id: 'Weightkg', title: 'Weight (kg)' },
      { id: 'Lengthcm', title: 'Length (cm)' },
      { id: 'Widthcm', title: 'Width (cm)' },
      { id: 'Heightcm', title: 'Height (cm)' },
      { id: 'Allowcustomerreviews', title: 'Allow customer reviews?' },
      { id: 'Purchasenote', title: 'Purchase note' },
      { id: 'Saleprice', title: 'Sale price' },
      { id: 'Regularprice', title: 'Regular price' },
      { id: 'Categories', title: 'Categories' },
      { id: 'Tags', title: 'Tags' },
      { id: 'Shippingclass', title: 'Shipping class' },
      { id: 'Images', title: 'Images' },
      { id: 'Downloadlimit', title: 'Download limit' },
      { id: 'Downloadexpirydays', title: 'Download expiry days' },
      { id: 'Parent', title: 'Parent' },
      { id: 'Groupedproducts', title: 'Grouped products' },
      { id: 'Upsells', title: 'Upsells' },
      { id: 'Cross-sells', title: 'Cross-sells' },
      { id: 'ExternalURL', title: 'External URL' },
      { id: 'Buttontext', title: 'Button text' },
      { id: 'Position', title: 'Position' },
      { id: 'Attribute1name', title: 'Attribute 1 name' },
      { id: 'Attribute1values', title: 'Attribute 1 value(s)' },
      { id: 'Attribute1visible', title: 'Attribute 1 visible' },
      { id: 'Attribute1global', title: 'Attribute 1 global' },
      { id: 'Attribute2name', title: 'Attribute 2 name' },
      { id: 'Attribute2values', title: 'Attribute 2 value(s)' },
      { id: 'Attribute2visible', title: 'Attribute 2 visible' },
      { id: 'Attribute2global', title: 'Attribute 2 global' },
      { id: 'Attribute3name', title: 'Attribute 3 name' },
      { id: 'Attribute3values', title: 'Attribute 3 value(s)' },
      { id: 'Attribute3visible', title: 'Attribute 3 visible' },
      { id: 'Attribute3global', title: 'Attribute 3 global' },
      { id: 'Attribute4name', title: 'Attribute 4 name' },
      { id: 'Attribute4values', title: 'Attribute 4 value(s)' },
      { id: 'Attribute4visible', title: 'Attribute 4 visible' },
      { id: 'Attribute4global', title: 'Attribute 4 global' },
      { id: 'Attribute5name', title: 'Attribute 5 name' },
      { id: 'Attribute5values', title: 'Attribute 5 value(s)' },
      { id: 'Attribute5visible', title: 'Attribute 5 visible' },
      { id: 'Attribute5global', title: 'Attribute 5 global' },
      { id: 'Attribute6name', title: 'Attribute 6 name' },
      { id: 'Attribute6values', title: 'Attribute 6 value(s)' },
      { id: 'Attribute6visible', title: 'Attribute 6 visible' },
      { id: 'Attribute6global', title: 'Attribute 6 global' }
    ]
});

fs.createReadStream(`./import_files/${nowObj.year}${nowObj.month}.csv`)
  .pipe(csv())
  .on('data', function (row) {
    console.log(row);
    const book = {
      Type: 'simple',
      SKU: "",
      Name: row.Title,
      Published: 1,
      Isfeatured: 0,
      Visibilityincatalog: 'visible',
      Shortdescription: row.Description,
      Description: row.Description,
      Datesalepricestarts: "",
      Datesalepriceends: "",
      Taxstatus: "taxable",
      Taxclass: "",
      Instock: 1,
      Stock: 1,
      Lowstockamount: 1,
      Backordersallowed: 0,
      Soldindividually: 1,
      Weightkg: "",
      Lengthcm: "",
      Widthcm: "",
      Heightcm: "",
      Allowcustomerreviews: 1,
      Purchasenote: "",
      Saleprice: "",
      Regularprice: 0,
      Categories: `${row.Category} > ${row.SubCategory}, ${row.Category}`, // TODO: check this
      Tags: row.Tags + `,sach-thang-${nowObj.nextMonth}-2021`,
      Shippingclass: "",
      Images: row.Images,
      Downloadlimit: "",
      Downloadexpirydays: "",
      Parent: "",
      Groupedproducts: "",
      Upsells: "",
      Crosssells: "",
      ExternalURL: "",
      Buttontext: "",
      Position: 0,
      Attribute1name: "Tác giả",
      Attribute1values: row.Author,
      Attribute1visible: 1,
      Attribute1global: 1,
      Attribute2name: "Nhà xuất bản",
      Attribute2values: row.Publisher,
      Attribute2visible: 1,
      Attribute2global: 1,
      Attribute3name: "Năm xuất bản",
      Attribute3values: row.Datepublished,
      Attribute3visible: 1,
      Attribute3global: 1,
      Attribute4name: "Giá sách",
      Attribute4values: "Giá " + row.Shelflist,
      Attribute4visible: 1,
      Attribute4global: 1,
      Attribute5name: "Vị Trí Sách",
      Attribute5values: "Thứ tự " + row.Position.padStart(3, 0),
      Attribute5visible: 1,
      Attribute5global: 1,
      Attribute6name: "Giá trị sách",
      Attribute6values: "500,000đ",
      Attribute6visible: 1,
      Attribute6global: 1
    }
    books.push(book)
  })
  .on('end', function () {
    console.log("...Writing...");
      csvWriter.writeRecords(books).then(() => {
        console.log(`...Done-${books.length} books`);
      })
    })
